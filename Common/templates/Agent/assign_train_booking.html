{% extends 'Agent/layout/header.html' %}

{% block content %}

{% if user %}
<!-- start page content -->
{% include 'cotrav_alert_message.html' %}
<div class="page-content-wrapper">
    <div class="page-content">

        <div class="text-center">
     <div style="font-size:14px; font-weight:bold;">
         Assign Train Booking
         </div>
   </div>

{% for booking in bookings %}

        <form method="post" action="/agents/assign-train-booking/{{booking.id}}" enctype="multipart/form-data">
    <input type="hidden" name="booking_id" value="{{booking.id}}">
    <input type="hidden" name="user_id" value="{{user.id}}">
    <input type="hidden" name="current_url" value="{{ request.get_full_path }}">
    <input type="hidden" name="checkin" id="checkin" value="{{ booking.checkin_datetime }}">
    <input type="hidden" name="checkout" id="checkout" value="{{ booking.checkout_datetime }}">
    <input type="hidden" name="tax_on_management_fee" id="tax_on_management_fee" value="0">
    <input type="hidden" name="tax_on_management_fee_percentage" id="tax_on_management_fee_percentage" value="0">
    <input type="hidden" name="management_fee_igst" id="management_fee_igst" value="0">
    <input type="hidden" name="management_fee_cgst" id="management_fee_cgst" value="0">
    <input type="hidden" name="management_fee_sgst" id="management_fee_sgst" value="0">
    <input type="hidden" name="management_fee_igst_rate" id="management_fee_igst_rate" value="0">
    <input type="hidden" name="management_fee_cgst_rate" id="management_fee_cgst_rate" value="0">
    <input type="hidden" name="management_fee_sgst_rate" id="management_fee_sgst_rate" value="0">

        <div class="row">

            <div class="col-md-3">
                <div class="card">
                    <div class="card-head card-topline-aqua">
                        <header>Basic Details</header>
                    </div>
                    <div class="card-body no-padding height-9">

                        <div class="form-group row">
                            <label class="col-sm-5 control-label">Reference No</label>
                            <div class="col-sm-7">

                                <input class="form-control" name="group_name" placeholder="Group Name"
                                     readonly  type="text" value="{{ booking.reference_no }}">
                            </div>
                        </div>



                         <div class="form-group row">
                            <label class="col-sm-5 control-label">City Name</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="group_name" placeholder="City Name"
                                     readonly  type="text" value="{{ booking.city_name }}">
                            </div>
                        </div>

                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Pickup Location</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="pickup_location" placeholder="Pickup Location"
                                     readonly  type="text" value="{{ booking.pickup_location }}">
                            </div>
                        </div>

                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Drop Location</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="drop_location" placeholder="Drop Location"
                                     readonly  type="text" value="{{ booking.drop_location }}">
                            </div>
                        </div>

                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Pickup Date</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="pickup_datetime" placeholder="Pickup Datetime"
                                     readonly  type="text" value="{{ booking.pickup_to_datetime }}">
                            </div>
                        </div>


                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Booking Date</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="booking_date" placeholder="Booking Date"
                                     readonly  type="text" value="{{ booking.booking_datetime }}">
                            </div>
                        </div>

                         <div class="form-group row">
                            <label class="col-sm-5 control-label">No Of Seats</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="no_of_seats" placeholder="No Of Seats"
                                     readonly  type="text" value="{{ booking.no_of_seats }}">
                            </div>
                        </div>

                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Booking Reason</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="reason_booking" placeholder="Booking Reason"
                                     readonly  type="text" value="{{ booking.reason_booking }}">
                            </div>
                        </div>


                    </div>
                </div>
            </div>




            <div class="col-md-3">

                <div class="card">
                    <div class="card-head card-topline-aqua">
                        <header>Assign Details</header>
                    </div>
                    <div class="card-body no-padding height-9">



                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Train Name</label>
                            <div class="col-sm-7">
                               <input class="form-control" type="text" name="train_name" placeholder="Train Number">
                            </div>
                        </div>

                          <div class="form-group row">
                            <label class="col-sm-5 control-label">Ticket Number</label>
                            <div class="col-sm-7">
                               <input class="form-control" type="text" name="ticket_no" placeholder="Ticket Number">
                            </div>
                        </div>

                            <div class="form-group row">
                            <label class="col-sm-5 control-label">PNR Number</label>
                            <div class="col-sm-7">
                               <input class="form-control" type="text" name="pnr_no" placeholder="PNR Number">
                            </div>
                        </div>


                            <div class="form-group row">
                                <label class="col-sm-5" >Train Type*</label>
                                <div class="col-sm-7">
                                 <select name="assign_bus_type_id" class="form-control myselect">
                                        {% for type in types %}
                                         <option value="{{type.id}}">{{type.name}}</option>
                                        {% endfor %}
                                  </select>
                                    </div>
                            </div>

                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Operator Name</label>
                            <div class="col-sm-7">
                               <input class="form-control" type="text" name="operator_name" placeholder="Operator Name">
                            </div>
                        </div>

                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Operator Contact</label>
                            <div class="col-sm-7">
                               <input class="form-control" type="text" name="operator_contact" placeholder="Operator Contact">
                            </div>
                        </div>

                           <div class="form-group row">
                            <label class="col-sm-5 control-label">Seat Number</label>
                            <div class="col-sm-7">
                               <input class="form-control" type="text" name="seat_no" placeholder="Seat Number">
                            </div>
                        </div>

                            <div class="form-group row">
                            <label class="col-sm-5 control-label">Portal Used</label>
                            <div class="col-sm-7">
                               <input class="form-control" type="text" name="portal_used" placeholder="Portal Used">
                            </div>
                        </div>

                           <div class="form-group row">
                            <label class="col-sm-5 control-label">Boarding Point</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="boarding_point" type="text" value="{{ booking.boarding_point }}">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-sm-5 control-label">Boarding Time</label>
                            <div class="col-sm-7">
                                <input class="form-control date-format" name="boarding_datetime" type="text" value="{{ booking.boarding_datetime|default:'' }}">
                            </div>
                        </div>






                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Send Client SMS</label>
                            <div class="col-sm-7">
                                <select class="form-control" name="is_client_sms">
                                    <option value="1">Yes</option>
                                    <option value="0">No</option>
                                </select>
                            </div>
                        </div>

                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Send Client Email</label>
                            <div class="col-sm-7">
                                 <select class="form-control" name="is_client_email">
                                    <option value="1">Yes</option>
                                    <option value="0">No</option>
                                </select>
                            </div>
                        </div>

                         <div class="form-group">
                            <div class="offset-md-3 col-md-9">
                                <button type="submit" class="btn btn-info">Assign</button>
                            </div>
                        </div>



                    </div>
                </div>


            </div>


             <div class="col-md-3">

                    <div class="card">
                      <div class="card-head card-topline-aqua">
                          <header>Billing Details</header>
                      </div>
                      <div class="card-body no-padding height-9">

                          <div class="form-group row">
                              <label class="col-sm-6 control-label">Ticket Price:</label>
                              <div class="col-sm-6">
                                    <input type="number" name="ticket_price" id="ticket_price" class="form-control" required >
                              </div>
                          </div>

                        <div class="form-group row">
                                <label class="col-sm-6 control-label">Management_fee:</label>
                                <div class="col-sm-6">
                                        <input type="text" name="management_fee" id="mng_fee" class="form-control" readonly >
                                </div>
                        </div>

                        <div class="form-group row">
                                <label class="col-sm-6 control-label">Tax amount management fee:</label>
                                <div class="col-sm-6">
                                        <input type="text" name="tax_mng_amt" id="tax_mng_amt" class="form-control" readonly >



                                </div>
                        </div>

                        <div class="form-group row">
                                <label class="col-sm-6 control-label">Total billing amount</label>
                                <div class="col-sm-6">
                                        <input type="text" name="sub_total" id="total_billing_amt" class="form-control" readonly >
                                </div>
                        </div>


                      {% for c_enttity in c_entitys %}

                          <div class="form-group row">
                                <label class="col-sm-6 control-label">Select Cotrav Billing Entity</label>
                                <div class="col-sm-6">

                                        <select class="form-control" id="cotrav_billing_entity" required name="cotrav_billing_entity">


                                                <option value="{{c_enttity.id}}" gst="{{c_enttity.gst_id}}">{{c_enttity.entity_name}} </option>


                                        </select>

                                </div>
                        </div>

                       {% endfor %}

                        <div class="form-group row">
                                <label class="col-sm-6 control-label">Booking Billing Entity</label>
                                <div class="col-sm-6">

                                        <input type="text" class="form-control" name="bb_entity" gst="{{be_gst}}" id="booking_billing_entity" value="{{be_name}}">

                                </div>
                        </div>



                        <div class="form-group row">
                                <label class="col-sm-6 control-label">CGST (perscentage)</label>
                                <div class="col-sm-6">

                                        <input type="text" class="form-control" name="cgst" id="cgst"  readonly>

                                </div>
                        </div>

                        <div class="form-group row">
                                <label class="col-sm-6 control-label">SGST (perscentage)</label>
                                <div class="col-sm-6">

                                        <input type="text"  class="form-control" name="sgst" id="sgst"  readonly>

                                </div>
                        </div>

                        <div class="form-group row">
                                <label class="col-sm-6 control-label">IGST (perscentage)</label>
                                <div class="col-sm-6">

                                        <input type="text" class="form-control" name="igst" id="igst"  readonly>

                                </div>
                        </div>

                          <div class="form-group row" id="client-tkt" >
                                <label class="col-sm-6 control-label">Browse Train Ticket</label>
                                <div class="col-sm-6">

                                        <input type="file" class="form-control" name="busticketToUpload" id="bus-ticket">
                                </div>
                           </div>


                       </div>
                  </div>
              </div>


             <div class="col-md-3">

                  <div class="card">
                    <div class="card-head card-topline-aqua">
                        <header>Passenger Details</header>
                    </div>




                     {% for passenger in booking.Passangers %}
                      <div class="card-body no-padding height-9">
                        <div class="form-group row">
                            <label class="col-sm-3 control-label">Name</label>
                            <label class="col-sm-7 control-label">{{passenger.employee_name}}</label>
                            <label class="col-sm-3 control-label">Email</label>
                            <label class="col-sm-7 control-label">{{passenger.employee_email}}</label>
                            <label class="col-sm-3 control-label">contact</label>
                            <label class="col-sm-7 control-label">{{passenger.employee_contact}}</label>
                            <label class="col-sm-3 control-label">age</label>
                            <label class="col-sm-7 control-label">{{passenger.age}}</label>
                            <label class="col-sm-3 control-label">gender</label>
                            <label class="col-sm-7 control-label">{{passenger.gender}}</label>
                            <label class="col-sm-3 control-label"><input typt="text" name="coach_{{passenger.id}}" placeholder="coa" value=""></label>
                            <label class="col-sm-7 control-label"><input typt="text" name="seat_no_{{passenger.id}}" placeholder="seat no" value=""></label>
                        </div>
                           </div>
                    {% endfor %}



                </div>
            </div>


             <div class="col-md-3">

                  <div class="card">
                    <div class="card-head card-topline-aqua">
                        <header>Boarding Details</header>
                    </div>
                    <div class="card-body no-padding height-9">

                        <div class="form-group row">
                            <label class="col-sm-5 control-label">Boarding Point</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="boarding_point1" type="text" value="{{ booking.boarding_point }}">
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-sm-5 control-label">Boarding Time</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="boarding_datetime1" type="text" value="{{ booking.boarding_datetime }}">
                            </div>
                        </div>



                    </div>
                </div>
            </div>



            <div class="col-md-3">

                  <div class="card">
                    <div class="card-head card-topline-aqua">
                        <header>Spoc Details</header>
                    </div>
                    <div class="card-body no-padding height-9">

                        <div class="form-group row">
                            <label class="col-sm-5 control-label">Spoc Name</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="group_name" readonly  type="text" value="{{ booking.user_name }}">
                            </div>
                        </div>

                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Spoc Email</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="user_email" readonly  type="text" value="{{ booking.email }}">
                            </div>
                        </div>

                         <div class="form-group row">
                            <label class="col-sm-5 control-label">Spoc Contact</label>
                            <div class="col-sm-7">
                                <input class="form-control" name="user_contact" readonly  type="text" value="{{ booking.user_contact }}">
                            </div>
                        </div>




                    </div>
                </div>
            </div>




        </div>

</form>






 {% endfor %}

    </div>
</div>
<!-- end page content -->


{% else %}
<p>Welcome, new user. Please log in.<a href="/login">Login</a></p>
{% endif %}

<script type="text/javascript">

$('#taxi_details').change(function(){
     var taxi_detail = $('#taxi_details option:selected').data('details');
    temp = taxi_detail.split(',');

    if(temp[0] != '' ){
        $("#taxi_reg_no").val(temp[0]);
        $("#garage_location").val(temp[1]);
        $("#garage_distance").val(temp[2]);
     }
     else{
        $("#taxi_reg_no").val('');
        $("#garage_location").val('');
        $("#garage_distance").val('');
     }
});
 </script>

<script type="text/javascript">
function valueChanged()
{

    if($('.client_ticket').is(":checked"))
        $("#client-tkt").hide();
    else
        $("#client-tkt").show();


}
</script>


<script>

        $( document ).ready(function() {

            var corporate_id =  1;

            var service_type = 1;

            var_url = '{{ API_BASE_URL }}'+'get_corporate_management_fee'

    $.ajaxSetup({
            headers:{
                    'Authorization': "Token {{request.session.agent_access_token}}",
                    'usertype': {{request.session.login_type}}
                }
        });

        $.post(var_url,{ corporate_id: corporate_id , service_type: service_type },
      function(data)
      {

      management_fee = data["Fees"][0].service_fees_type_value
      $('#mng_fee').val(management_fee);
      $('#oper_mng_fee').val(management_fee);
       });



            $('#ticket_price').keyup(function(event){
                if(event.which != 8 && isNaN(String.fromCharCode(event.which))){
                        event.preventDefault(); //stop character from entering input
                }else{

                    var ticket_price = this.value;
                    var management_fee = $('#mng_fee').val();
                    var tax_perscent_on_management_fee = 18;
                    var tax_perscentage = 0.18
                    var tax_amount_on_management_fee = 0;
                    var total_billing_amount = 0;
                    var cgst = 0.0;
                    var sgst = 0.0;
                    var igst = 0.0;

                    if ($('#mng_fee').val() == "")
                    {
                        management_fee = 100
                        $('#mng_fee').val(management_fee);
                    }

                    tax_amount_on_management_fee =  management_fee * tax_perscentage;

                    management_fee_with_tax =  parseFloat(management_fee) + parseInt(tax_amount_on_management_fee);

                    total_billing_amount = parseFloat(ticket_price) + parseFloat(management_fee_with_tax)

                    $('#tax_mng_amt').val(tax_amount_on_management_fee);

                    $('#total_billing_amt').val(total_billing_amount);

                    val1 = $("#booking_billing_entity").attr("gst");
                    val2 = $('option:selected',"#cotrav_billing_entity").val();

                    console.log(val1);
                    console.log(val2);

                    //alert(val1);
                    //alert(val2);

                    match = val1.localeCompare(val2);

                    var v1 = val1.substring(0, 2);

                    var v2 = val2.substring(0, 2);


                    if(v1 == v2)
                    {
                       // alert("value matched");
                        cgst = 9;
                        sgst = 9;

                        $('#management_fee_cgst').val(cgst);
                        $('#management_fee_sgst').val(sgst);
                        var cgst_rate = tax_amount_on_management_fee/2;
                        $('#management_fee_cgst_rate').val(cgst_rate);
                        $('#management_fee_sgst_rate').val(cgst_rate);


                    }else{

                        igst = 18;

                        $('#management_fee_igst').val(igst);
                        $('#management_fee_igst_rate').val(tax_amount_on_management_fee);

                    }

                     $('#cgst').val(cgst);

                    $('#sgst').val(sgst);

                    $('#igst').val(igst);

                    $('#tax_on_management_fee').val(tax_amount_on_management_fee);

                    $('#tax_on_management_fee_percentage').val(tax_perscent_on_management_fee);



                }
            });


             $('#oper_ticket_price').keyup(function(event){
                if(event.which != 8 && isNaN(String.fromCharCode(event.which))){
                        event.preventDefault(); //stop character from entering input
                }else{

                  var oper_ticket_price = $('#oper_ticket_price').val();

                 var operator_gst_id = $('#operator_gst_id').val();

                  var operator_commission = $('#operator_commission').val();

                  var cgst_val = $('#oper_cgst').val();

                  var sgst_val = $('#oper_sgst').val();

                  var igst_val = $('#oper_igst').val();

                  var gst_tax = 0.0;

                  if(cgst_val == 0.0)
                  {
                    gst_tax = 0.18;
                  }
                  else{
                    gst_tax = 0.9;
                  }

                  var gst_paid =  parseFloat(oper_ticket_price) * parseFloat(gst_tax);

                  $('#gst_paid').val(gst_paid);




                }
            });


        });

</script>


 {% endblock %}